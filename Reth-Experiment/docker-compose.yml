version: '3.8'

services:
  reth:
    build:
      context: .
      dockerfile: Reth-Dockerfile
    container_name: reth
    restart: unless-stopped
    networks:
      - eth-network
    ports:
      - "30303:30303/tcp"    # P2P TCP
      - "30303:30303/udp"    # P2P UDP
      - "8545:8545"          # HTTP RPC
      - "8551:8551"          # Engine API (for Prysm)
    volumes:
      - /data:/data          # Mount 3TB storage - Reth data at /data/reth, logs at /data/logs/reth.log
    environment:
      - RETH_DATADIR=/data/reth
    logging:
      driver: "json-file"
      options:
        max-size: "200m"
        max-file: "5"
        tag: "reth"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  prysm:
    build:
      context: .
      dockerfile: Prysm-Dockerfile
    container_name: prysm
    restart: unless-stopped
    networks:
      - eth-network
    ports:
      - "4000:4000"          # Beacon API (gRPC)
      - "13000:13000/tcp"    # P2P TCP
      - "12000:12000/udp"    # P2P UDP
      - "8080:8080"          # Monitoring/metrics
    volumes:
      - /data:/data          # Mount same volume - Prysm data at /data/prysm, logs at /data/logs/prysm.log
    environment:
      - PRYSM_DATADIR=/data/prysm
    logging:
      driver: "json-file"
      options:
        max-size: "200m"
        max-file: "5"
        tag: "prysm"
    depends_on:
      reth:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

networks:
  eth-network:
    driver: bridge

